
F I L E   T R A N S F E R   P R O T O C O L
===========================================
FTP jest protokołem transferu plików w modelu klient-serwer wykorzystujący protokół TCP. FTP jest protokołem 8-bitowym i
   dlatego nie wymaga kodowania danych do 7 bitów, tak jak w przypadku poczty elektronicznej.

   Do komunikacji wykorzystywane są dwa połączenia TCP:
     * kontrolne - przesył poleceń (zazwyczaj port 21)
     * dane - transmisja danych (zazwyczaj port 20, ale zależne to jest on trybu pracy FTP),

   Bezpieczne wersje FTP pozwalają na zaszyfrowanie nazwy użytkownika wraz z hasłem jak i samych danych:
     * FTPS - Protokół FTP zaszyfrowany poprzez SSL/TLS,
     * SFTP -  SSH File Transfer Protocol


   Standardy:
     * RFC 959,
     * RFC 1579 - Rozszerzenie FTP o Firewall-Friendly FTP (passive mode),
     * RFC 2228 - Rozszerzenia bezpieczeństwa,
     * RFC 2428 - Wsparcie dla IPv6 oraz definicja nowego typu trybu pasywnego,



Tryby pracy
-----------
Połączenie za pomocą protokołu FTP może działać w dwóch trybach, aktywnym i pasywnym, które decyduje jak połączenie dla
   transmisji danych zostanie zestawione.

- Tryb aktywny:

                           klient                                       serwer
                         data   cmd                                   cmd   data
                          :      |                                     :      :
                          :      | N                                21 :      :
                          :      |---------------- PORT -------------->|      :
                          :      |<--------------- ACK ----------------|      :
                          : N+1                                            20 |
                          |<--------------------------------------------------|
                          |----------------------- ACK ---------------------->|
                          :                                                   :

     - Przepływ połączenia:
          * PORT - Klient łączy się z przypadkowego nieuprzywilejowanego numeru portu (N > 1023) do portu poleceń (port
             21) na serwerze. Klient wskazuje w tym poleceniu swój numer portu na którym będzie nasłuchiwał na dane
             pochodzące od serwera FTP (zazwyczaj jest to port N+1).
          * ACK - Serwer potwierdza połączenie.
          * Serwer inicjalizuje połączenia dla komunikacji danych ze swojego lokalnego portu (port 20) na port klienta
             wskazany przez niego wcześniej (port N+1).
          * ACK - Klient potwierdza połączenie.

     - Firewall - Główny problem związany z trybem aktywnym leży po stronie klienta, ponieważ to serwer FTP zestawia
        faktyczne połączenie do klienta na potrzeby komunikacji danych. Firewall po stronie klienta zazwyczaj blokuje
        próby zestawienia takich połączeń. Aby firewall po stronie klienta wspierał aktywny tryb FTP poniższe kanały
        komunikacyjne muszą być otwarte:
          * FTP server's port 21 from anywhere (Client initiates connection)
          * FTP server's port 21 to ports > 1023 (Server responds to client's control port)
          * FTP server's port 20 to ports > 1023 (Server initiates data connection to client's data port)
          * FTP server's port 20 from ports > 1023 (Client sends ACKs to server's data port)


- Tryb pasywny:

                           klient                                       serwer
                         data   cmd                                   cmd   data
                          :      |                                     :      :
                          :      | N                                21 :      :
                          :      |---------------- PASV -------------->|      :
                          :      |<--------------- ACK ----------------|      :
                          : N+1                                             P |
                          |-------------------------------------------------->|
                          |<---------------------- ACK -----------------------|
                          :                                                   :

     - Przepływ połączenia:
          * PASV - Klient łączy się z przypadkowego nieuprzywilejowanego numeru portu (N > 1023) do portu poleceń (port
             21) na serwerze. Serwer po odebraniu żądania otwiera nowy port na nieuprzywilejowanym numerze (P > 1023) na
             którym będzie nasłuchiwał przychodzących pakietów danych od klienta na potrzeby komunikacji danych.
          * ACK - Serwer potwierdza połączenie wskazując numer portu P na którym nasłuchuje danych od klienta.
          * Klient inicjalizuje połączenia dla komunikacji danych ze swojego lokalnego portu (N+1) na otrzymany
             wcześniej numer port serwera (port P).
          * ACK - Serwer potwierdza połączenie.

     - Firewall - Aby firewall po stronie serwera wspierał pasywny tryb FTP poniższe kanały komunikacyjne muszą być
        otwarte:
          * FTP server's port 21 from anywhere (Client initiates connection)
          * FTP server's port 21 to ports > 1023 (Server responds to client's control port)
          * FTP server's ports > 1023 from anywhere (Client initiates data connection to random port specified by server
          * FTP server's ports > 1023 to remote ports > 1023 (Server sends ACKs (and data) to client's data port)


jeżeli połączenie FTP działa w trybie aktywnym to używa portu 21 dla poleceń – zestawiane przez klienta i portu 20 do przesyłu danych – zestawiane przez serwer;
jeżeli połączenie FTP pracuje w trybie pasywnym to wykorzystuje port 21 dla poleceń i port o numerze powyżej 1024 do transmisji danych – obydwa połączenia zestawiane są przez klienta.
W sieciach chronionych zaporą sieciową (ang. firewall) komunikacja z serwerami FTP wymaga zwolnienia odpowiednich portów na zaporze sieciowej lub routerze. Możliwe jest zainstalowanie wielu serwerów FTP na jednym routerze. Warunkiem jest rozdzielenie portów przez router dla każdego serwera.
